<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación S3 Local</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Simulación de Amazon S3 Local</h1>

        <div class="main-content">
            <div class="upload-section">
                <h2>Subir Archivo</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="fileInput" name="file" required>
                    <button type="submit">Subir Archivo</button>
                </form>
                <div id="uploadMessage"></div>
            </div>

            <div class="files-section">
                <h2>Archivos en el Bucket</h2>
                <button id="refreshBtn">Actualizar Lista</button>
                <div id="filesList"></div>
                <div id="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadMessage = document.getElementById('uploadMessage');
        const refreshBtn = document.getElementById('refreshBtn');
        const filesList = document.getElementById('filesList');
        const pagination = document.getElementById('pagination');

        let currentPage = 1;
        const perPage = 5;

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    uploadMessage.innerHTML = '<p class="success">' + result.message + '</p>';
                    fileInput.value = '';
                    loadFiles(currentPage);
                } else {
                    uploadMessage.innerHTML = '<p class="error">' + result.error + '</p>';
                }
            } catch (error) {
                uploadMessage.innerHTML = '<p class="error">Error al subir el archivo</p>';
            }
        });

        refreshBtn.addEventListener('click', () => loadFiles(currentPage));

        async function loadFiles(page = 1) {
            try {
                const response = await fetch(`/files?page=${page}&per_page=${perPage}`);
                const data = await response.json();
                if (response.ok) {
                    currentPage = data.page;
                    const files = data.files;
                    if (files.length === 0) {
                        filesList.innerHTML = '<p>No hay archivos en el bucket</p>';
                        pagination.innerHTML = '';
                    } else {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Nombre del Archivo</th>
                                    <th>Tamaño (bytes)</th>
                                    <th>Última Modificación</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${files.map(file => `
                                    <tr>
                                        <td>${file.key}</td>
                                        <td>${file.size}</td>
                                        <td>${new Date(file.last_modified).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        filesList.innerHTML = '';
                        filesList.appendChild(table);

                        // Paginación
                        renderPagination(data.total_pages, data.page);
                    }
                } else {
                    filesList.innerHTML = '<p class="error">' + data.error + '</p>';
                    pagination.innerHTML = '';
                }
            } catch (error) {
                filesList.innerHTML = '<p class="error">Error al cargar los archivos</p>';
                pagination.innerHTML = '';
            }
        }

        function renderPagination(totalPages, currentPage) {
            pagination.innerHTML = '';
            if (totalPages <= 1) return;

            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';

            // Anterior
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Anterior';
                prevBtn.onclick = () => loadFiles(currentPage - 1);
                paginationDiv.appendChild(prevBtn);
            }

            // Páginas
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => loadFiles(i);
                paginationDiv.appendChild(pageBtn);
            }

            // Siguiente
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Siguiente';
                nextBtn.onclick = () => loadFiles(currentPage + 1);
                paginationDiv.appendChild(nextBtn);
            }

            pagination.appendChild(paginationDiv);
        }

        // Cargar archivos al iniciar
        loadFiles();
    </script>
</body>
</html>